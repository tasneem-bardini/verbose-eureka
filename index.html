<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>TAMM • Sahatna • Having a Baby (Prototype)</title>
  <style>
    :root{
      --bg:#0b0f14;
      --card:#111a24;
      --text:#e8f0ff;
      --muted:rgba(232,240,255,.65);
      --muted2:rgba(232,240,255,.45);
      --line:rgba(255,255,255,.08);
      --accent:#19e3c0;
      --accent2:#21b9ff;
      --danger:#ff5d5d;
      --dangerBg: rgba(255,93,93,.14);
      --good:#36e38e;
      --goodBg: rgba(54,227,142,.14);
      --shadow: 0 16px 40px rgba(0,0,0,.55);
      --radius2:22px;
      --font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:var(--font);
      background:
        radial-gradient(1200px 700px at 70% -10%, rgba(33,185,255,.25), transparent 55%),
        radial-gradient(900px 600px at -10% 20%, rgba(25,227,192,.16), transparent 55%),
        linear-gradient(180deg, #0b0f14 0%, #070a0e 100%);
      color:var(--text);
      display:flex;
      align-items:center;
      justify-content:center;
      padding:20px;
    }

    /* Phone frame */
    .phone{
      width:min(420px, 100%);
      height: min(860px, 100%);
      background: linear-gradient(180deg, #070b10 0%, #0b0f14 35%, #070a0e 100%);
      border-radius: 34px;
      border: 1px solid rgba(255,255,255,.08);
      box-shadow: var(--shadow);
      overflow:hidden;
      position:relative;
    }
    .statusbar{
      height:34px;
      padding:10px 14px 0;
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      font-size:12px;
      color:rgba(232,240,255,.7);
      letter-spacing:.2px;
    }
    .statusbar .right{display:flex; gap:10px; align-items:center}
    .pill-dot{width:10px;height:10px;border-radius:999px;background:rgba(232,240,255,.35)}
    .notch{
      position:absolute; top:10px; left:50%;
      transform:translateX(-50%);
      width:140px; height:24px;
      border-radius:999px;
      background:rgba(0,0,0,.25);
      border:1px solid rgba(255,255,255,.06);
      backdrop-filter: blur(8px);
      pointer-events:none;
      opacity:.75;
    }

    /* Header */
    .header{
      padding:14px 16px 14px;
      background:
        radial-gradient(220px 160px at 30% 10%, rgba(33,185,255,.35), transparent 60%),
        radial-gradient(280px 180px at 70% -10%, rgba(25,227,192,.22), transparent 62%),
        linear-gradient(180deg, rgba(20,88,140,.55) 0%, rgba(10,20,32,.0) 70%);
      border-bottom:1px solid rgba(255,255,255,.06);
    }
    .toprow{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-bottom:10px;
    }
    .iconbtn{
      width:36px; height:36px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(0,0,0,.18);
      display:grid; place-items:center;
      cursor:pointer;
      transition:transform .12s ease, background .12s ease;
      user-select:none;
      color:rgba(232,240,255,.92);
    }
    .iconbtn:active{transform:scale(.96)}
    .iconbtn:hover{background:rgba(255,255,255,.06)}
    .titlewrap{
      display:flex; flex-direction:column;
      line-height:1.15;
      gap:3px;
      min-width:0;
      flex:1;
    }
    .space{font-size:12px;color:rgba(232,240,255,.65)}
    .journey{
      font-size:20px;
      font-weight:750;
      letter-spacing:.2px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .subtitle{font-size:12px;color:rgba(232,240,255,.55);margin-top:2px}

    .stagebar, .subbar{
      display:flex;
      gap:8px;
      overflow:auto;
      padding-bottom:2px;
      scrollbar-width:none;
    }
    .stagebar::-webkit-scrollbar,.subbar::-webkit-scrollbar{display:none}

    .pill{
      flex:0 0 auto;
      padding:10px 12px;
      border-radius:999px;
      background:rgba(255,255,255,.07);
      border:1px solid rgba(255,255,255,.08);
      color:rgba(232,240,255,.75);
      font-size:12px;
      cursor:pointer;
      user-select:none;
      transition:background .15s ease, transform .12s ease, border-color .15s ease;
      display:flex; align-items:center; gap:8px;
      white-space:nowrap;
    }
    .pill .dot{width:8px;height:8px;border-radius:999px;background:rgba(232,240,255,.30)}
    .pill.active{
      background:linear-gradient(135deg, rgba(25,227,192,.20), rgba(33,185,255,.18));
      border-color:rgba(33,185,255,.35);
      color:rgba(232,240,255,.95);
    }
    .pill.active .dot{background:var(--accent)}
    .pill:active{transform:scale(.98)}

    /* Content */
    .content{
      height: calc(100% - 34px);
      overflow:auto;
      padding:14px 14px 110px;
      scrollbar-width:thin;
      scrollbar-color: rgba(255,255,255,.12) transparent;
    }
    .section{margin-top:12px}
    .sectionhead{
      display:flex; align-items:center; justify-content:space-between;
      margin:14px 2px 10px;
    }
    .sectionhead h3{margin:0;font-size:14px;letter-spacing:.2px}
    .linkbtn{
      border:none;background:none;
      color:rgba(33,185,255,.95);
      font-size:12px;cursor:pointer;
      padding:6px 8px;border-radius:10px;
    }
    .linkbtn:hover{background:rgba(33,185,255,.08)}

    .card{
      background:linear-gradient(180deg, rgba(17,26,36,.92), rgba(13,19,28,.92));
      border:1px solid rgba(255,255,255,.08);
      border-radius:var(--radius2);
      padding:14px;
      box-shadow: 0 14px 30px rgba(0,0,0,.35);
    }
    .card + .card{margin-top:10px}
    .row{display:flex; align-items:center; justify-content:space-between; gap:10px}
    .muted{color:var(--muted)}
    .muted2{color:var(--muted2)}

    .chips{display:flex; flex-wrap:wrap; gap:8px; margin-top:10px}
    .chip{
      font-size:11px;
      padding:7px 10px;
      border-radius:999px;
      background:rgba(255,255,255,.07);
      border:1px solid rgba(255,255,255,.08);
      color:rgba(232,240,255,.70);
    }

    .cta{display:flex; gap:10px; margin-top:12px; flex-wrap:wrap}
    .btn{
      border:none; cursor:pointer;
      border-radius:999px;
      padding:11px 14px;
      font-weight:650;
      font-size:13px;
      letter-spacing:.15px;
      transition:transform .12s ease, filter .12s ease, background .12s ease;
      user-select:none;
      white-space:nowrap;
    }
    .btn:active{transform:scale(.98)}
    .btn.primary{
      background:linear-gradient(135deg, rgba(25,227,192,1), rgba(33,185,255,.85));
      color:#052019;
      flex:1;
      min-width:150px;
    }
    .btn.ghost{
      background:rgba(255,255,255,.08);
      border:1px solid rgba(255,255,255,.10);
      color:rgba(232,240,255,.90);
    }
    .btn.danger{
      background:rgba(255,93,93,.14);
      border:1px solid rgba(255,93,93,.30);
      color:rgba(255,255,255,.92);
    }
    .btn.small{padding:9px 12px; font-size:12px}

    .kpiwrap{display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:10px}
    .kpi{
      background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.08);
      border-radius:16px;
      padding:12px;
    }
    .kpi .label{font-size:11px;color:rgba(232,240,255,.60)}
    .kpi .value{font-size:16px;font-weight:800;margin-top:4px}
    .kpi .hint{font-size:11px;color:rgba(232,240,255,.45);margin-top:4px}

    .divider{height:1px;background:rgba(255,255,255,.06);margin:10px 0}

    /* List items */
    .list{display:flex; flex-direction:column; gap:10px}
    .item{
      background:linear-gradient(180deg, rgba(15,23,33,.88), rgba(12,18,26,.88));
      border:1px solid rgba(255,255,255,.08);
      border-radius:18px;
      padding:12px;
      display:flex;
      gap:12px;
      cursor:pointer;
      transition:transform .12s ease, background .12s ease, border-color .12s ease;
    }
    .item:hover{border-color:rgba(33,185,255,.20)}
    .item:active{transform:scale(.99)}

    .thumb{
      width:56px;height:56px;border-radius:14px;
      background:
        radial-gradient(40px 40px at 30% 30%, rgba(33,185,255,.35), transparent 65%),
        radial-gradient(50px 50px at 80% 20%, rgba(25,227,192,.25), transparent 60%),
        linear-gradient(135deg, rgba(255,255,255,.08), rgba(0,0,0,.05));
      border:1px solid rgba(255,255,255,.08);
      flex:0 0 auto;
      display:grid; place-items:center;
      color:rgba(232,240,255,.80);
    }
    .item .meta{min-width:0; flex:1}
    .item .meta .t{
      font-weight:750;
      font-size:13px;
      margin:2px 0 4px;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }
    .item .meta .d{
      font-size:12px; color:rgba(232,240,255,.55);
      display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical;
      overflow:hidden;
    }
    .tags{display:flex; flex-wrap:wrap; gap:6px; margin-top:8px}
    .tag{
      font-size:11px; padding:5px 8px; border-radius:999px;
      background:rgba(255,255,255,.07);
      border:1px solid rgba(255,255,255,.08);
      color:rgba(232,240,255,.65);
    }
    .tag.good{background:var(--goodBg); border-color:rgba(54,227,142,.35); color:rgba(232,240,255,.9)}
    .tag.bad{background:var(--dangerBg); border-color:rgba(255,93,93,.35); color:rgba(232,240,255,.95)}
    .chev{margin-left:auto;color:rgba(232,240,255,.35);display:flex;align-items:center;padding-left:6px}

    /* Screening result styling */
    .resultCard{
      border-radius:18px;
      padding:12px;
      border:1px solid rgba(255,255,255,.08);
      background:linear-gradient(180deg, rgba(15,23,33,.88), rgba(12,18,26,.88));
      cursor:pointer;
      transition:transform .12s ease, border-color .12s ease;
    }
    .resultCard:hover{border-color:rgba(33,185,255,.20)}
    .resultCard:active{transform:scale(.99)}
    .resultTop{display:flex; align-items:flex-start; justify-content:space-between; gap:10px}
    .resultName{font-weight:850; font-size:13px}
    .resultMeta{font-size:12px; color:rgba(232,240,255,.55); margin-top:4px; line-height:1.35}
    .signal{
      display:flex; align-items:center; gap:8px;
      padding:8px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.06);
      font-size:12px;
      white-space:nowrap;
    }
    .signal.good{border-color:rgba(54,227,142,.28); background:rgba(54,227,142,.10)}
    .signal.bad{border-color:rgba(255,93,93,.35); background:rgba(255,93,93,.12)}
    .signal .dot{
      width:10px;height:10px;border-radius:999px;
      background:rgba(232,240,255,.30);
    }
    .signal.good .dot{background:var(--good)}
    .signal.bad .dot{background:var(--danger)}
    .signal.bad .warn{font-weight:900}

    /* Toast */
    .toast{
      position:absolute;
      left:50%;
      transform:translateX(-50%);
      bottom:92px;
      background:rgba(12,18,26,.95);
      border:1px solid rgba(255,255,255,.10);
      border-radius:999px;
      padding:10px 12px;
      font-size:12px;
      color:rgba(232,240,255,.85);
      display:none;
      box-shadow:0 10px 30px rgba(0,0,0,.5);
      white-space:nowrap;
      max-width:90%;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    /* Modal */
    .modalback{
      position:absolute; inset:0;
      background:rgba(0,0,0,.55);
      display:none;
      align-items:flex-end;
      justify-content:center;
      padding:12px;
    }
    .modal{
      width:100%;
      max-width:420px;
      background:linear-gradient(180deg, rgba(18,26,38,.98), rgba(10,14,20,.98));
      border:1px solid rgba(255,255,255,.10);
      border-radius:26px;
      box-shadow: var(--shadow);
      padding:14px;
      transform:translateY(6px);
      animation: up .16s ease-out;
    }
    @keyframes up{from{transform:translateY(18px); opacity:.6} to{transform:translateY(6px); opacity:1}}
    .modal .handle{width:46px;height:5px;border-radius:999px;background:rgba(255,255,255,.18);margin:4px auto 10px}
    .modal h4{margin:4px 2px 6px; font-size:14px}
    .modal p{margin:0 2px 10px; font-size:12px; color:rgba(232,240,255,.58); line-height:1.45; white-space:pre-wrap}
    .modal .grid{display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:8px}
    .modal .opt{
      padding:12px;border-radius:18px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.06);
      cursor:pointer;
      transition:transform .12s ease, background .12s ease;
    }
    .modal .opt:hover{background:rgba(33,185,255,.10)}
    .modal .opt:active{transform:scale(.99)}
    .modal .opt .k{font-size:11px; color:rgba(232,240,255,.60)}
    .modal .opt .v{font-size:13px; font-weight:750; margin-top:4px}

    /* Bottom nav */
    .nav{
      position:absolute; left:0; right:0; bottom:0;
      padding:10px 10px 14px;
      background:linear-gradient(180deg, rgba(11,15,20,0) 0%, rgba(11,15,20,.75) 25%, rgba(11,15,20,.96) 100%);
      border-top:1px solid rgba(255,255,255,.06);
      backdrop-filter: blur(10px);
    }
    .navrow{
      display:flex; justify-content:space-around; gap:10px;
      background:rgba(255,255,255,.05);
      border:1px solid rgba(255,255,255,.08);
      border-radius:22px;
      padding:10px 8px;
    }
    .navbtn{
      display:flex; flex-direction:column; align-items:center; gap:6px;
      font-size:11px; color:rgba(232,240,255,.55);
      padding:8px 10px;
      border-radius:16px;
      cursor:pointer;
      user-select:none;
    }
    .navbtn.active{
      color:rgba(232,240,255,.92);
      background:linear-gradient(135deg, rgba(25,227,192,.16), rgba(33,185,255,.14));
      border:1px solid rgba(33,185,255,.18);
    }
    .navicon{
      width:22px;height:22px;border-radius:8px;
      background:rgba(255,255,255,.07);
      border:1px solid rgba(255,255,255,.08);
      display:grid; place-items:center;
      color:rgba(232,240,255,.70);
    }

    /* icons */
    .svg{width:16px;height:16px; display:block}
    .svg.big{width:18px;height:18px}
  </style>
</head>
<body>
  <div class="phone" role="application" aria-label="TAMM prototype phone">
    <div class="notch" aria-hidden="true"></div>

    <div class="statusbar">
      <div>9:41</div>
      <div class="right">
        <div class="pill-dot"></div>
        <div class="pill-dot"></div>
        <div class="pill-dot"></div>
      </div>
    </div>

    <div class="header">
      <div class="toprow">
        <button class="iconbtn" id="backBtn" aria-label="Back">
          <svg class="svg big" viewBox="0 0 24 24" fill="none">
            <path d="M15 18l-6-6 6-6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </button>

        <div class="titlewrap">
          <div class="space">Sahatna Space</div>
          <div class="journey">Having a Baby</div>
          <div class="subtitle" id="stageSubtitle">Pregnancy services started • Profile created</div>
        </div>

        <button class="iconbtn" id="infoBtn" aria-label="Info">
          <svg class="svg big" viewBox="0 0 24 24" fill="none">
            <path d="M12 17v-6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            <path d="M12 7h.01" stroke="currentColor" stroke-width="3" stroke-linecap="round"/>
            <path d="M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" stroke="currentColor" stroke-width="2"/>
          </svg>
        </button>
      </div>

      <!-- Main journey stages -->
      <div class="stagebar" id="stagebar" aria-label="Journey stages">
        <div class="pill" data-stage="pre" role="button" tabindex="0"><span class="dot"></span>Pre-conception</div>
        <div class="pill active" data-stage="preg" role="button" tabindex="0"><span class="dot"></span>Pregnancy</div>
        <div class="pill" data-stage="birth" role="button" tabindex="0"><span class="dot"></span>Birth</div>
        <div class="pill" data-stage="post" role="button" tabindex="0"><span class="dot"></span>Post-birth</div>
      </div>
    </div>

    <div class="content" id="content"></div>

    <div class="toast" id="toast"></div>

    <div class="nav" aria-label="Bottom navigation">
      <div class="navrow">
        <div class="navbtn active" data-view="dashboard">
          <div class="navicon">
            <svg class="svg" viewBox="0 0 24 24" fill="none">
              <path d="M4 11h7V4H4v7Zm9 9h7v-7h-7v7ZM4 20h7v-7H4v7Zm9-9h7V4h-7v7Z" stroke="currentColor" stroke-width="1.8" stroke-linejoin="round"/>
            </svg>
          </div>
          Dashboard
        </div>
        <div class="navbtn" data-view="resources">
          <div class="navicon">
            <svg class="svg" viewBox="0 0 24 24" fill="none">
              <path d="M6 4h12v16H6V4Z" stroke="currentColor" stroke-width="1.8"/>
              <path d="M9 8h6M9 12h6M9 16h4" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/>
            </svg>
          </div>
          Resources
        </div>
        <div class="navbtn" data-view="appointments">
          <div class="navicon">
            <svg class="svg" viewBox="0 0 24 24" fill="none">
              <path d="M7 3v3M17 3v3" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/>
              <path d="M4 8h16" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/>
              <path d="M6 6h12a2 2 0 0 1 2 2v12a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2Z" stroke="currentColor" stroke-width="1.8"/>
              <path d="M8 12h4" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/>
            </svg>
          </div>
          Appointments
        </div>
        <div class="navbtn" data-view="profile">
          <div class="navicon">
            <svg class="svg" viewBox="0 0 24 24" fill="none">
              <path d="M20 21a8 8 0 1 0-16 0" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/>
              <path d="M12 13a4 4 0 1 0 0-8 4 4 0 0 0 0 8Z" stroke="currentColor" stroke-width="1.8"/>
            </svg>
          </div>
          Me
        </div>
      </div>
    </div>

    <!-- Bottom sheet modal -->
    <div class="modalback" id="modalBack" aria-hidden="true">
      <div class="modal" role="dialog" aria-modal="true" aria-label="Details">
        <div class="handle"></div>
        <h4 id="modalTitle">Title</h4>
        <p id="modalDesc">Description</p>
        <div class="divider"></div>
        <div class="grid" id="modalGrid"></div>
        <div class="cta">
          <button class="btn ghost" id="modalClose">Close</button>
          <button class="btn primary" id="modalPrimary">Confirm</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ---------------------------
    // Utilities
    // ---------------------------
    function addDays(date, days){
      const d = new Date(date);
      d.setDate(d.getDate() + days);
      return d;
    }
    function addMonths(date, months){
      const d = new Date(date);
      const day = d.getDate();
      d.setMonth(d.getMonth() + months);
      // if month overflow caused date to shift (e.g., 31st -> next month), snap to last day
      if (d.getDate() < day) d.setDate(0);
      return d;
    }
    function fmtDate(d){
      const dd = new Date(d);
      return dd.toLocaleDateString(undefined, { weekday:"short", year:"numeric", month:"short", day:"numeric" });
    }
    function fmtShort(d){
      const dd = new Date(d);
      return dd.toLocaleDateString(undefined, { month:"short", day:"numeric" });
    }
    function escapeHtml(str){
      return String(str)
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    // "Demo time" support so you can SEE the 2-days-before notification in the prototype
    function now(){
      return state.simNow ? new Date(state.simNow) : new Date();
    }

    // ---------------------------
    // Prototype data
    // ---------------------------
    const STAGES = {
      pre:  { name:"Pre-conception", subtitle:"Planning (prototype navigation only)" },
      preg: { name:"Pregnancy", subtitle:"Pregnancy services started • Tailored education & appointments" },
      birth:{ name:"Birth", subtitle:"Birth • Delivery planning & admission" },
      post: { name:"Post-birth", subtitle:"Post-birth • Newborn Screening, Vaccination, Home Visitation" }
    };

    const POST_TABS = {
      nbs:   { name:"Newborn Screening" },
      vacc:  { name:"Vaccination Schedule" },
      visit: { name:"Home Visitation Program" }
    };

    // ---------------------------
    // State
    // ---------------------------
    let state = {
      stage: "preg",
      view: "dashboard",
      simNow: null, // set by demo buttons to showcase notifications
      deliveryCompleted: false,
      post: { tab:"nbs", nbsFilter:"all" },
      journey: {
        hospitalEvent: { facility:"Hospital (prototype)", event:"Positive pregnancy test confirmed", date: new Date() },
        testDate: new Date(),
        dueDate: addDays(new Date(), 260),
        motherAppointments: [],
        baby: {
          name: "Baby",
          birthDate: null,
          screenings: [],   // NBS results after birth
          vaccines: [],     // schedule items
          appointments: []  // booked vaccination & home visitation/teleconsultation
        },
        notifications: [] // reminders, especially vaccination: 2 days in advance
      }
    };

    // ---------------------------
    // UI refs
    // ---------------------------
    const contentEl = document.getElementById("content");
    const stageSubtitle = document.getElementById("stageSubtitle");
    const stageBar = document.getElementById("stagebar");
    const navBtns = Array.from(document.querySelectorAll(".navbtn"));
    const toastEl = document.getElementById("toast");

    // Modal
    const modalBack = document.getElementById("modalBack");
    const modalTitle = document.getElementById("modalTitle");
    const modalDesc  = document.getElementById("modalDesc");
    const modalGrid  = document.getElementById("modalGrid");
    const modalClose = document.getElementById("modalClose");
    const modalPrimary = document.getElementById("modalPrimary");

    function showToast(msg){
      toastEl.textContent = msg;
      toastEl.style.display = "block";
      clearTimeout(showToast._t);
      showToast._t = setTimeout(()=> toastEl.style.display = "none", 2300);
    }

    function openModal({title, desc, options = [], primaryLabel="Confirm", primaryAction=()=>{}}){
      modalTitle.textContent = title;
      modalDesc.textContent = desc;
      modalGrid.innerHTML = "";
      options.forEach(opt=>{
        const div = document.createElement("div");
        div.className = "opt";
        div.innerHTML = `<div class="k">${escapeHtml(opt.k)}</div><div class="v">${escapeHtml(opt.v)}</div>`;
        div.onclick = () => opt.onClick?.();
        modalGrid.appendChild(div);
      });
      modalPrimary.textContent = primaryLabel;
      modalPrimary.onclick = () => { primaryAction(); closeModal(); };
      modalBack.style.display = "flex";
      modalBack.setAttribute("aria-hidden","false");
    }

    function closeModal(){
      modalBack.style.display = "none";
      modalBack.setAttribute("aria-hidden","true");
    }

    function setStage(stageKey){
      state.stage = stageKey;
      Array.from(stageBar.querySelectorAll(".pill")).forEach(el=>{
        el.classList.toggle("active", el.dataset.stage === stageKey);
      });
      stageSubtitle.textContent = STAGES[stageKey].subtitle;
      render();
      showToast(`Stage: ${STAGES[stageKey].name}`);
    }

    function setView(view){
      state.view = view;
      navBtns.forEach(b=> b.classList.toggle("active", b.dataset.view === view));
      render();
    }

    // ---------------------------
    // Auto create profile & start pregnancy services
    // ---------------------------
    function generateMotherAppointments(testDate, dueDate){
      const t = new Date(testDate);
      const d = new Date(dueDate);

      const templates = [
        { id:"m1", title:"First prenatal visit (OB-GYN / Midwife)", date:addDays(t, 3), type:"Consultation", stage:"preg" },
        { id:"m2", title:"Dating ultrasound scan",                date:addDays(t, 10), type:"Scan",         stage:"preg" },
        { id:"m3", title:"Anatomy scan (20-week scan)",           date:addDays(t, 90), type:"Scan",         stage:"preg" },
        { id:"m4", title:"Birth plan appointment",                date:addDays(d, -20),type:"Planning",     stage:"birth" },
        { id:"m5", title:"Delivery (estimated due date)",         date:d,              type:"Delivery",     stage:"birth" }
      ];

      return templates
        .map(x => ({...x, status:"Booked", location:"Hospital / Clinic (prototype)", for:"mother"}))
        .sort((a,b)=> new Date(a.date) - new Date(b.date));
    }

    function initPregnancyFlow(){
      state.stage = "preg";
      state.view = "dashboard";
      state.journey.motherAppointments = generateMotherAppointments(state.journey.testDate, state.journey.dueDate);
      // profile is assumed auto-created from the hospital record
      showToast("Profile auto-created • Pregnancy services active");
    }

    // ---------------------------
    // Post-birth: Birth completed -> create NBS results + vaccines schedule
    // ---------------------------
    function generateNBSResults(babyBirthDate){
      const base = addDays(babyBirthDate, 1); // day after birth in ward (prototype)
      return [
        {
          id:"nbs-hearing",
          name:"Hearing Screening (NBS)",
          status:"Negative",
          date: base,
          summary:"No concerns identified in hearing screening.",
          details:"Result: Negative (Normal)\n\nNext steps:\n• No further action needed unless symptoms appear.\n• Continue routine follow-ups as per pediatric guidance."
        },
        {
          id:"nbs-physical",
          name:"Physical Examination (NBS)",
          status:"Negative",
          date: base,
          summary:"Normal newborn physical examination.",
          details:"Result: Negative (Normal)\n\nNext steps:\n• Routine care.\n• Ask the nurse/doctor if you have concerns."
        },
        {
          id:"nbs-congenital",
          name:"Congenital Screening (NBS)",
          status:"Positive",
          date: base,
          summary:"A potential concern was detected and needs follow-up.",
          details:"Result: Positive (Alert)\n\nThis does not always mean a confirmed condition.\n\nNext steps:\n• A confirmatory test will be arranged.\n• A clinician will explain the findings and the plan.\n• You can book a follow-up appointment in TAMM."
        }
      ];
    }

    function generateVaccineSchedule(babyBirthDate){
      const months = [1,2,4,6,8,12];
      return months.map(m => ({
        id:`vx-${m}`,
        month: m,
        label: `${m} month vaccination`,
        dueDate: addMonths(babyBirthDate, m),
        status: "Due",          // Due | Booked | Completed
        appointmentId: null
      })).sort((a,b)=> new Date(a.dueDate)-new Date(b.dueDate));
    }

    function completeBirthAndTransferToPostnatal(){
      if(state.deliveryCompleted) return;

      state.deliveryCompleted = true;

      // baby is born now (prototype)
      const birthDate = now();
      state.journey.baby.birthDate = birthDate;

      // create newborn screening results
      state.journey.baby.screenings = generateNBSResults(birthDate);

      // create vaccination schedule
      state.journey.baby.vaccines = generateVaccineSchedule(birthDate);

      // jump to post-birth stage and default sub-stage = NBS
      state.stage = "post";
      state.post.tab = "nbs";
      state.post.nbsFilter = "all";
      state.view = "dashboard";

      // update stage pills UI
      Array.from(stageBar.querySelectorAll(".pill")).forEach(el=>{
        el.classList.toggle("active", el.dataset.stage === "post");
      });
      stageSubtitle.textContent = STAGES.post.subtitle;

      showToast("Birth completed • Transferred to postnatal ward");
      render();
    }

    // ---------------------------
    // Notifications (2 days before vaccination appointment)
    // ---------------------------
    function scheduleReminderForAppointment(appt){
      // exactly as requested: 2 days in advance
      const fireDate = addDays(appt.date, -2);

      const reminder = {
        id: `ntf-${Math.random().toString(16).slice(2)}`,
        fireDate,
        apptId: appt.id,
        title: "Upcoming vaccination appointment",
        message: `Your baby’s vaccination appointment is in 2 days: ${appt.title} on ${fmtDate(appt.date)}.`
      };

      state.journey.notifications.push(reminder);
      state.journey.notifications.sort((a,b)=> new Date(a.fireDate)-new Date(b.fireDate));
    }

    function getActiveNotifications(){
      const t = now();
      // Active window: from fireDate until the appointment date
      const apptById = getAllAppointments().reduce((acc,a)=> (acc[a.id]=a, acc), {});
      return state.journey.notifications.filter(n=>{
        const appt = apptById[n.apptId];
        if(!appt) return false;
        return (new Date(n.fireDate) <= t) && (t < new Date(appt.date));
      });
    }

    // ---------------------------
    // Booking flows
    // ---------------------------
    function bookNextVaccination(){
      if(!state.deliveryCompleted){
        showToast("Complete birth first (prototype).");
        return;
      }
      const next = state.journey.baby.vaccines.find(v => v.status === "Due");
      if(!next){
        showToast("No due vaccines left (prototype).");
        return;
      }

      let selectedDate = new Date(next.dueDate);

      openModal({
        title: `Book vaccination • ${next.month} month`,
        desc:
          `Baby: ${state.journey.baby.name}\n` +
          `Due date: ${fmtDate(next.dueDate)}\n\n` +
          `Confirm the vaccination appointment date.\n` +
          `After confirmation, TAMM will send a reminder 2 days before the appointment.`,
        options: [
          { k:"Select date", v: fmtDate(selectedDate) },
          { k:"Adjust", v:"+ 3 days", onClick: ()=>{ selectedDate = addDays(selectedDate, 3); showToast(`Selected: ${fmtDate(selectedDate)}`);} },
          { k:"Adjust", v:"- 3 days", onClick: ()=>{ selectedDate = addDays(selectedDate, -3); showToast(`Selected: ${fmtDate(selectedDate)}`);} },
          { k:"Demo", v:"Set appointment 5 days from today", onClick: ()=>{ selectedDate = addDays(now(), 5); showToast(`Selected: ${fmtDate(selectedDate)}`);} }
        ],
        primaryLabel: "Confirm booking",
        primaryAction: ()=>{
          // create appointment
          const appt = {
            id: `bvx-${Math.random().toString(16).slice(2)}`,
            for: "baby",
            title: `Vaccination • ${next.month} month`,
            type: "Vaccination",
            date: selectedDate,
            location: "Vaccination clinic (prototype)",
            status: "Confirmed"
          };
          state.journey.baby.appointments.push(appt);

          // link to vaccine schedule item
          next.status = "Booked";
          next.appointmentId = appt.id;

          // schedule reminder 2 days before
          scheduleReminderForAppointment(appt);

          showToast("Vaccination booked • Reminder scheduled (2 days before)");
          render();
        }
      });
    }

    function bookHomeVisitOrTele(type){
      if(!state.deliveryCompleted){
        showToast("Complete birth first (prototype).");
        return;
      }

      const isHome = type === "home";
      const title = isHome ? "Home visitation" : "Teleconsultation";

      openModal({
        title: `Book ${title}`,
        desc:
          (isHome
            ? "A clinician visits you at home to support mother & baby postnatal care."
            : "A remote consultation (video/phone) for postnatal support and questions."
          ) +
          "\n\nNext steps (prototype):\n" +
          (isHome
            ? "1) Choose date/time\n2) Confirm home address\n3) Confirm booking"
            : "1) Choose date/time\n2) Confirm preferred contact method\n3) Confirm booking"
          ),
        options: [
          { k:"Service", v: title },
          { k:"When", v: "Choose date/time (placeholder)", onClick: ()=> showToast("Choose time (prototype).") },
          { k:"Details", v: isHome ? "Confirm address" : "Confirm contact method", onClick: ()=> showToast("Enter details (prototype).") }
        ],
        primaryLabel: "Confirm",
        primaryAction: ()=>{
          const appt = {
            id: `post-${Math.random().toString(16).slice(2)}`,
            for: "baby",
            title: isHome ? "Home visitation (postnatal)" : "Teleconsultation (postnatal)",
            type: isHome ? "Home Visit" : "Teleconsultation",
            date: addDays(now(), 7), // placeholder
            location: isHome ? "Home address (prototype)" : "Virtual (prototype)",
            status: "Requested"
          };
          state.journey.baby.appointments.push(appt);
          showToast(`${title} requested (prototype).`);
          render();
        }
      });
    }

    // ---------------------------
    // Queries
    // ---------------------------
    function getAllAppointments(){
      const mother = state.journey.motherAppointments || [];
      const baby = state.journey.baby.appointments || [];
      return [...mother, ...baby].sort((a,b)=> new Date(a.date)-new Date(b.date));
    }

    // ---------------------------
    // Renderers
    // ---------------------------
    function renderDashboardPregnancy(){
      const appts = state.journey.motherAppointments;
      const next = appts.find(a => new Date(a.date) >= now()) || appts[0];

      contentEl.innerHTML = `
        <div class="card">
          <div class="row">
            <div style="min-width:0">
              <div style="font-size:12px;color:rgba(232,240,255,.60);margin-bottom:6px">Hospital-triggered start</div>
              <div style="font-size:16px;font-weight:850;letter-spacing:.2px">${escapeHtml(state.journey.hospitalEvent.event)}</div>
              <div class="muted" style="font-size:12px;line-height:1.45;margin-top:6px">
                Facility: ${escapeHtml(state.journey.hospitalEvent.facility)}<br/>
                Confirmation date: ${fmtDate(state.journey.testDate)}<br/>
                Profile: <b>Auto-created</b> • Pregnancy services: <b>Active</b>
              </div>
              <div class="chips">
                <span class="chip">Appointments booked</span>
                <span class="chip">Tailored education</span>
              </div>
            </div>
            <div class="thumb" aria-hidden="true">${svgBadge("heart")}</div>
          </div>
          <div class="cta">
            <button class="btn primary" id="goAppts">View appointments</button>
            <button class="btn ghost" id="jumpBirth">Go to Birth stage</button>
          </div>
        </div>

        <div class="section">
          <div class="sectionhead">
            <h3>Next appointment</h3>
            <button class="linkbtn" id="apptsAll">View all</button>
          </div>

          <div class="card">
            <div style="font-weight:850">${escapeHtml(next?.title || "—")}</div>
            <div class="muted" style="font-size:12px;margin-top:6px;line-height:1.45">
              ${next ? `${fmtDate(next.date)} • ${escapeHtml(next.location)}` : "No appointments (prototype)."}
            </div>
            <div class="cta">
              <button class="btn primary" id="simulateBirth">Simulate birth & go to Post-birth</button>
              <button class="btn ghost" id="demoReset">Reset demo date</button>
            </div>
          </div>
        </div>
      `;

      document.getElementById("goAppts").onclick = ()=> setView("appointments");
      document.getElementById("apptsAll").onclick = ()=> setView("appointments");
      document.getElementById("jumpBirth").onclick = ()=> setStage("birth");
      document.getElementById("simulateBirth").onclick = ()=> completeBirthAndTransferToPostnatal();
      document.getElementById("demoReset").onclick = ()=> { state.simNow=null; showToast("Demo date reset."); render(); };
    }

    function renderDashboardBirth(){
      contentEl.innerHTML = `
        <div class="card">
          <div style="font-size:12px;color:rgba(232,240,255,.60);margin-bottom:6px">Birth stage</div>
          <div style="font-size:18px;font-weight:900">Delivery & admission (prototype)</div>
          <div class="muted" style="font-size:12px;line-height:1.45;margin-top:6px">
            When birth is completed, mother & baby transfer to the postnatal ward.
          </div>
          <div class="cta">
            <button class="btn primary" id="completeBirth">Complete birth & transfer to postnatal</button>
            <button class="btn ghost" id="viewSchedule">View schedule</button>
          </div>
        </div>

        <div class="section">
          <div class="sectionhead">
            <h3>Appointments</h3>
            <button class="linkbtn" id="apptsAll">View all</button>
          </div>

          <div class="list" id="birthApptList"></div>
        </div>
      `;

      const birthAppts = state.journey.motherAppointments.filter(a => a.stage === "birth");
      const list = document.getElementById("birthApptList");
      list.innerHTML = birthAppts.map(a => `
        <div class="item" data-appt="${a.id}">
          <div class="thumb">${svgBadge("cal")}</div>
          <div class="meta">
            <div class="t">${escapeHtml(a.title)}</div>
            <div class="d">${fmtDate(a.date)} • ${escapeHtml(a.location)}</div>
            <div class="tags">
              <span class="tag">${escapeHtml(a.type)}</span>
              <span class="tag">${escapeHtml(a.status)}</span>
            </div>
          </div>
          <div class="chev">›</div>
        </div>
      `).join("");

      document.getElementById("completeBirth").onclick = ()=> completeBirthAndTransferToPostnatal();
      document.getElementById("viewSchedule").onclick = ()=> setView("appointments");
      document.getElementById("apptsAll").onclick = ()=> setView("appointments");

      list.querySelectorAll("[data-appt]").forEach(el=>{
        el.onclick = ()=>{
          const appt = state.journey.motherAppointments.find(x=>x.id===el.dataset.appt);
          if(!appt) return;
          openModal({
            title: appt.title,
            desc: `${fmtDate(appt.date)}\n${appt.location}\n\nStatus: ${appt.status}`,
            options: [
              {k:"Type", v: appt.type},
              {k:"Stage", v: "Birth"}
            ],
            primaryLabel: "OK",
            primaryAction: ()=>{}
          });
        };
      });
    }

    function renderPostDashboard(){
      const baby = state.journey.baby;
      const activeNotifs = getActiveNotifications();

      const banner = !state.deliveryCompleted ? `
        <div class="card">
          <div style="font-size:12px;color:rgba(232,240,255,.60);margin-bottom:6px">Post-birth stage</div>
          <div style="font-size:16px;font-weight:900">Complete birth to start postnatal programs</div>
          <div class="muted" style="font-size:12px;line-height:1.45;margin-top:6px">
            Prototype gate: newborn screening and vaccination schedule become available after birth.
          </div>
          <div class="cta">
            <button class="btn primary" id="postCompleteBirth">Complete birth now</button>
            <button class="btn ghost" id="postBackBirth">Go to Birth stage</button>
          </div>
        </div>
      ` : `
        <div class="card">
          <div class="row">
            <div style="min-width:0">
              <div style="font-size:12px;color:rgba(232,240,255,.60);margin-bottom:6px">Postnatal ward</div>
              <div style="font-size:16px;font-weight:900">Mother & baby transferred</div>
              <div class="muted" style="font-size:12px;line-height:1.45;margin-top:6px">
                Baby: <b>${escapeHtml(baby.name)}</b><br/>
                Birth date: ${fmtDate(baby.birthDate)}<br/>
                Demo date: ${fmtDate(now())} ${state.simNow ? "(simulated)" : "(real time)"}
              </div>
              <div class="chips">
                <span class="chip">Newborn Screening</span>
                <span class="chip">Vaccination schedule</span>
                <span class="chip">Home visitation</span>
              </div>
            </div>
            <div class="thumb" aria-hidden="true">${svgBadge("heart")}</div>
          </div>

          ${activeNotifs.length ? `
            <div class="divider"></div>
            <div style="font-weight:900;margin-bottom:6px">Notifications</div>
            ${activeNotifs.map(n=>`
              <div class="resultCard" style="border-color:rgba(33,185,255,.22);">
                <div class="resultTop">
                  <div>
                    <div class="resultName">${escapeHtml(n.title)}</div>
                    <div class="resultMeta">${escapeHtml(n.message)}</div>
                  </div>
                  <div class="signal good"><span class="dot"></span>Active</div>
                </div>
              </div>
            `).join("")}
          ` : ""}
        </div>
      `;

      // Post-birth sub-stages (separated via tabs)
      const subbar = `
        <div class="section">
          <div class="sectionhead">
            <h3>Post-birth programs</h3>
            <button class="linkbtn" id="resetDemo">Reset demo date</button>
          </div>
          <div class="subbar" id="postSubbar" aria-label="Post-birth sub-stages">
            <div class="pill ${state.post.tab==="nbs"?"active":""}" data-posttab="nbs"><span class="dot"></span>${POST_TABS.nbs.name}</div>
            <div class="pill ${state.post.tab==="vacc"?"active":""}" data-posttab="vacc"><span class="dot"></span>${POST_TABS.vacc.name}</div>
            <div class="pill ${state.post.tab==="visit"?"active":""}" data-posttab="visit"><span class="dot"></span>${POST_TABS.visit.name}</div>
          </div>
        </div>
      `;

      contentEl.innerHTML = banner + subbar + renderPostTabContent();

      // Wire banner
      const btn = document.getElementById("postCompleteBirth");
      if(btn) btn.onclick = ()=> completeBirthAndTransferToPostnatal();
      const back = document.getElementById("postBackBirth");
      if(back) back.onclick = ()=> setStage("birth");

      // Sub tabs
      const postSubbar = document.getElementById("postSubbar");
      postSubbar.querySelectorAll("[data-posttab]").forEach(el=>{
        el.onclick = ()=>{
          state.post.tab = el.dataset.posttab;
          render();
        };
      });

      // Demo reset
      document.getElementById("resetDemo").onclick = ()=>{
        state.simNow = null;
        showToast("Demo date reset.");
        render();
      };

      // Wire post-tab-specific controls after render
      wirePostTabInteractions();
    }

    function renderPostTabContent(){
      if(!state.deliveryCompleted){
        return `
          <div class="card">
            <div style="font-weight:900">Waiting for birth completion…</div>
            <div class="muted" style="font-size:12px;line-height:1.45;margin-top:6px">
              Complete birth to view Newborn Screening results and create the baby’s vaccination schedule.
            </div>
          </div>
        `;
      }

      if(state.post.tab === "nbs") return renderNBS();
      if(state.post.tab === "vacc") return renderVaccinations();
      if(state.post.tab === "visit") return renderVisitation();
      return "";
    }

    function renderNBS(){
      const baby = state.journey.baby;
      const filter = state.post.nbsFilter;

      const all = baby.screenings || [];
      const filtered = all.filter(r=>{
        if(filter === "all") return true;
        if(filter === "neg") return r.status === "Negative";
        if(filter === "pos") return r.status === "Positive";
        return true;
      });

      return `
        <div class="card">
          <div class="row">
            <div style="min-width:0">
              <div style="font-size:12px;color:rgba(232,240,255,.60);margin-bottom:6px">Newborn Screening (NBS)</div>
              <div style="font-size:18px;font-weight:900">Screening results</div>
              <div class="muted" style="font-size:12px;line-height:1.45;margin-top:6px">
                View your baby’s screening results for hearing, physical, and congenital checks.
                Positive results show an alert signal.
              </div>
            </div>
            <div class="thumb">${svgBadge("book")}</div>
          </div>

          <div class="divider"></div>
          <div class="chips" style="margin-top:0">
            <span class="chip" style="cursor:pointer" id="fltAll">All</span>
            <span class="chip" style="cursor:pointer" id="fltNeg">Negative</span>
            <span class="chip" style="cursor:pointer" id="fltPos">Positive</span>
          </div>
          <div class="muted2" style="font-size:11px;margin-top:8px">
            Filter: <b>${filter === "all" ? "All" : (filter === "neg" ? "Negative" : "Positive")}</b>
          </div>
        </div>

        <div class="section">
          <div class="sectionhead">
            <h3>Results</h3>
            <button class="linkbtn" id="nbsHelp">What does Positive mean?</button>
          </div>

          <div class="list">
            ${filtered.map(r=>{
              const isPos = r.status === "Positive";
              return `
                <div class="resultCard" data-nbs="${r.id}">
                  <div class="resultTop">
                    <div style="min-width:0">
                      <div class="resultName">${escapeHtml(r.name)}</div>
                      <div class="resultMeta">${fmtDate(r.date)} • ${escapeHtml(r.summary)}</div>
                      <div class="tags" style="margin-top:10px">
                        ${isPos
                          ? `<span class="tag bad">Positive</span><span class="tag">Follow-up needed</span>`
                          : `<span class="tag good">Negative</span><span class="tag">Normal</span>`
                        }
                      </div>
                    </div>
                    ${isPos
                      ? `<div class="signal bad" aria-label="Alert"><span class="dot"></span><span class="warn">⚠ Alert</span></div>`
                      : `<div class="signal good"><span class="dot"></span>Normal</div>`
                    }
                  </div>
                </div>
              `;
            }).join("")}
          </div>
        </div>
      `;
    }

    function renderVaccinations(){
      const baby = state.journey.baby;
      const schedule = baby.vaccines || [];
      const nextDue = schedule.find(v => v.status === "Due");
      const nextBooked = schedule.find(v => v.status === "Booked");
      const activeNotifs = getActiveNotifications();

      // Next reminder (scheduled but not yet active)
      const apptsById = (baby.appointments || []).reduce((acc,a)=> (acc[a.id]=a, acc), {});
      const futureReminders = state.journey.notifications
        .map(n=>({n, appt: apptsById[n.apptId]}))
        .filter(x=>x.appt && new Date(x.n.fireDate) > now())
        .sort((a,b)=> new Date(a.n.fireDate) - new Date(b.n.fireDate));

      const nextReminder = futureReminders[0] || null;

      return `
        <div class="card">
          <div class="row">
            <div style="min-width:0">
              <div style="font-size:12px;color:rgba(232,240,255,.60);margin-bottom:6px">Vaccination</div>
              <div style="font-size:18px;font-weight:900">Vaccination schedule</div>
              <div class="muted" style="font-size:12px;line-height:1.45;margin-top:6px">
                Schedule includes: 1, 2, 4, 6, 8, and 12 months.
                Book the next appointment and receive a reminder 2 days in advance.
              </div>
            </div>
            <div class="thumb">${svgBadge("cal")}</div>
          </div>

          <div class="divider"></div>

          <div class="kpiwrap">
            <div class="kpi">
              <div class="label">Next due</div>
              <div class="value">${nextDue ? `${nextDue.month} month` : "—"}</div>
              <div class="hint">${nextDue ? fmtDate(nextDue.dueDate) : "All scheduled"}</div>
            </div>
            <div class="kpi">
              <div class="label">Booked</div>
              <div class="value">${schedule.filter(v=>v.status==="Booked").length}</div>
              <div class="hint">${nextBooked ? `Next booked: ${nextBooked.month} month` : "None yet"}</div>
            </div>
          </div>

          <div class="cta">
            <button class="btn primary" id="bookNextVx" ${nextDue ? "" : "disabled"}>Book next vaccination</button>
            <button class="btn ghost" id="viewAllAppts">View all appointments</button>
          </div>
        </div>

        <div class="section">
          <div class="sectionhead">
            <h3>Schedule</h3>
            <button class="linkbtn" id="vxAbout">About reminders</button>
          </div>

          <div class="list">
            ${schedule.map(v=>{
              const statusTag =
                v.status === "Due" ? `<span class="tag">Due</span>` :
                v.status === "Booked" ? `<span class="tag good">Booked</span>` :
                `<span class="tag">Completed</span>`;

              const appt = v.appointmentId ? apptsById[v.appointmentId] : null;

              return `
                <div class="item" data-vx="${v.id}">
                  <div class="thumb">${svgBadge("cal")}</div>
                  <div class="meta">
                    <div class="t">${escapeHtml(v.label)}</div>
                    <div class="d">
                      Due: ${fmtDate(v.dueDate)}
                      ${appt ? `<br/>Appointment: ${fmtDate(appt.date)} • ${escapeHtml(appt.status)}` : ""}
                    </div>
                    <div class="tags">
                      ${statusTag}
                      <span class="tag">${v.month} mo</span>
                    </div>
                  </div>
                  <div class="chev">›</div>
                </div>
              `;
            }).join("")}
          </div>
        </div>

        <div class="section">
          <div class="sectionhead">
            <h3>Notifications</h3>
            <button class="linkbtn" id="demoTools">Demo tools</button>
          </div>

          <div class="card">
            <div style="font-weight:900">Reminder rule</div>
            <div class="muted" style="font-size:12px;line-height:1.45;margin-top:6px">
              Once a vaccination appointment is confirmed, a notification is scheduled exactly <b>2 days before</b>.
            </div>

            <div class="divider"></div>

            ${activeNotifs.length ? `
              <div class="signal good" style="display:inline-flex"><span class="dot"></span>Notification active</div>
              <div class="muted" style="font-size:12px;line-height:1.45;margin-top:10px">
                ${escapeHtml(activeNotifs[0].message)}
              </div>
            ` : `
              <div class="muted" style="font-size:12px;line-height:1.45">
                ${nextReminder
                  ? `Next reminder will trigger on <b>${fmtDate(nextReminder.n.fireDate)}</b> (for ${escapeHtml(nextReminder.appt.title)}).`
                  : "No reminders scheduled yet. Book a vaccination to create one."
                }
              </div>
            `}

            <div class="cta">
              <button class="btn ghost" id="fastForwardReminder" ${nextReminder ? "" : "disabled"}>Fast-forward to reminder date</button>
              <button class="btn ghost" id="fastForwardAppt" ${nextReminder ? "" : "disabled"}>Fast-forward to appointment date</button>
              <button class="btn danger" id="resetTime">Reset demo date</button>
            </div>
          </div>
        </div>
      `;
    }

    function renderVisitation(){
      return `
        <div class="card">
          <div style="font-size:12px;color:rgba(232,240,255,.60);margin-bottom:6px">Home Visitation Program</div>
          <div style="font-size:18px;font-weight:900">Choose your support option</div>
          <div class="muted" style="font-size:12px;line-height:1.45;margin-top:6px">
            Book a home visit or a teleconsultation. Each service is separate, with clear next steps.
          </div>
        </div>

        <div class="section">
          <div class="sectionhead">
            <h3>Services</h3>
            <button class="linkbtn" id="visitHelp">What happens next?</button>
          </div>

          <div class="card">
            <div style="font-weight:900">Home visitation</div>
            <div class="muted" style="font-size:12px;line-height:1.45;margin-top:6px">
              A clinician visits your home to support mother & baby (feeding, recovery, newborn care).
            </div>
            <div class="chips">
              <span class="chip">In-person support</span>
              <span class="chip">Home-based</span>
              <span class="chip">Postnatal guidance</span>
            </div>
            <div class="divider"></div>
            <div class="muted2" style="font-size:11px">Next steps</div>
            <div class="chips">
              <span class="chip">Choose date/time</span>
              <span class="chip">Confirm address</span>
              <span class="chip">Confirm booking</span>
            </div>
            <div class="cta">
              <button class="btn primary" id="bookHomeVisit">Book home visitation</button>
            </div>
          </div>

          <div class="card">
            <div style="font-weight:900">Teleconsultation</div>
            <div class="muted" style="font-size:12px;line-height:1.45;margin-top:6px">
              Remote consultation (video/phone) for questions and postnatal support.
            </div>
            <div class="chips">
              <span class="chip">Remote support</span>
              <span class="chip">Flexible timing</span>
              <span class="chip">Quick advice</span>
            </div>
            <div class="divider"></div>
            <div class="muted2" style="font-size:11px">Next steps</div>
            <div class="chips">
              <span class="chip">Choose date/time</span>
              <span class="chip">Confirm contact method</span>
              <span class="chip">Confirm booking</span>
            </div>
            <div class="cta">
              <button class="btn primary" id="bookTele">Book teleconsultation</button>
            </div>
          </div>
        </div>
      `;
    }

    function wirePostTabInteractions(){
      // NBS filter
      const fltAll = document.getElementById("fltAll");
      const fltNeg = document.getElementById("fltNeg");
      const fltPos = document.getElementById("fltPos");
      if(fltAll) fltAll.onclick = ()=>{ state.post.nbsFilter="all"; render(); };
      if(fltNeg) fltNeg.onclick = ()=>{ state.post.nbsFilter="neg"; render(); };
      if(fltPos) fltPos.onclick = ()=>{ state.post.nbsFilter="pos"; render(); };

      // NBS help + click result
      const nbsHelp = document.getElementById("nbsHelp");
      if(nbsHelp){
        nbsHelp.onclick = ()=> openModal({
          title:"Positive vs Negative (NBS)",
          desc:
            "Negative: No concern detected in screening.\n\n" +
            "Positive: A potential concern detected → follow-up testing is needed.\n\n" +
            "In this prototype, positive results show an ⚠ alert signal.",
          options:[
            {k:"Tip", v:"Tap a result to view details"},
            {k:"Next", v:"Book follow-up (future feature)"}
          ],
          primaryLabel:"OK",
          primaryAction: ()=>{}
        });
      }

      contentEl.querySelectorAll("[data-nbs]").forEach(el=>{
        el.onclick = ()=>{
          const r = state.journey.baby.screenings.find(x=>x.id===el.dataset.nbs);
          if(!r) return;
          const isPos = r.status === "Positive";
          openModal({
            title: r.name,
            desc: `${fmtDate(r.date)}\n\nStatus: ${r.status}\n\n${r.details}`,
            options:[
              {k:"Signal", v: isPos ? "⚠ Alert" : "Normal"},
              {k:"Stage", v:"Postnatal ward"}
            ],
            primaryLabel: isPos ? "Acknowledge" : "OK",
            primaryAction: ()=>{ showToast(isPos ? "Acknowledged (prototype)." : ""); }
          });
        };
      });

      // Vaccinations
      const bookNextVx = document.getElementById("bookNextVx");
      if(bookNextVx) bookNextVx.onclick = ()=> bookNextVaccination();

      const viewAllAppts = document.getElementById("viewAllAppts");
      if(viewAllAppts) viewAllAppts.onclick = ()=> setView("appointments");

      const vxAbout = document.getElementById("vxAbout");
      if(vxAbout){
        vxAbout.onclick = ()=> openModal({
          title:"Vaccination reminders",
          desc:
            "When you confirm a baby vaccination appointment, TAMM schedules a reminder exactly 2 days before.\n\n" +
            "This prototype includes demo tools to fast-forward time so you can see the notification state.",
          options:[
            {k:"Rule", v:"Reminder = Appointment - 2 days"},
            {k:"Demo", v:"Use fast-forward buttons"}
          ],
          primaryLabel:"OK",
          primaryAction: ()=>{}
        });
      }

      contentEl.querySelectorAll("[data-vx]").forEach(el=>{
        el.onclick = ()=>{
          const v = state.journey.baby.vaccines.find(x=>x.id===el.dataset.vx);
          if(!v) return;

          const appt = v.appointmentId
            ? state.journey.baby.appointments.find(a=>a.id===v.appointmentId)
            : null;

          openModal({
            title: v.label,
            desc:
              `Due: ${fmtDate(v.dueDate)}\n` +
              `Status: ${v.status}\n\n` +
              (appt ? `Appointment: ${fmtDate(appt.date)} (${appt.status})\nLocation: ${appt.location}\n\n` : "") +
              "Next iteration: vaccine types list, contraindications, consent, and clinic selection.",
            options:[
              {k:"Month", v:`${v.month}`},
              {k:"Action", v: (v.status==="Due" ? "Book now" : (v.status==="Booked" ? "View appointment" : "Completed"))}
            ],
            primaryLabel: (v.status==="Due" ? "Book" : "OK"),
            primaryAction: ()=>{
              if(v.status==="Due") bookNextVaccination();
            }
          });
        };
      });

      // Notifications demo tools
      const demoTools = document.getElementById("demoTools");
      if(demoTools){
        demoTools.onclick = ()=> showToast("Use fast-forward buttons below (prototype).");
      }

      const fastForwardReminder = document.getElementById("fastForwardReminder");
      const fastForwardAppt = document.getElementById("fastForwardAppt");
      const resetTime = document.getElementById("resetTime");

      if(fastForwardReminder || fastForwardAppt){
        // find next future reminder and its appointment
        const apptsById = (state.journey.baby.appointments || []).reduce((acc,a)=> (acc[a.id]=a, acc), {});
        const future = state.journey.notifications
          .map(n=>({n, appt: apptsById[n.apptId]}))
          .filter(x=>x.appt && new Date(x.n.fireDate) > now())
          .sort((a,b)=> new Date(a.n.fireDate)-new Date(b.n.fireDate))[0];

        if(future){
          if(fastForwardReminder){
            fastForwardReminder.onclick = ()=>{
              state.simNow = new Date(future.n.fireDate);
              showToast(`Demo date set: ${fmtDate(state.simNow)} (reminder active)`);
              render();
            };
          }
          if(fastForwardAppt){
            fastForwardAppt.onclick = ()=>{
              state.simNow = new Date(future.appt.date);
              showToast(`Demo date set: ${fmtDate(state.simNow)} (appointment day)`);
              render();
            };
          }
        }
      }

      if(resetTime){
        resetTime.onclick = ()=>{
          state.simNow = null;
          showToast("Demo date reset.");
          render();
        };
      }

      // Home visitation
      const visitHelp = document.getElementById("visitHelp");
      if(visitHelp){
        visitHelp.onclick = ()=> openModal({
          title:"Home visitation • Next steps",
          desc:
            "Home visitation:\n1) Choose date/time\n2) Confirm address\n3) Clinician visits\n\n" +
            "Teleconsultation:\n1) Choose date/time\n2) Confirm contact method\n3) Join via link/call\n\n" +
            "Prototype: bookings create a request entry in appointments.",
          options:[
            {k:"Tip", v:"Check Appointments after booking"},
            {k:"Future", v:"Add eligibility & triage rules"}
          ],
          primaryLabel:"OK",
          primaryAction: ()=>{}
        });
      }

      const bookHomeVisit = document.getElementById("bookHomeVisit");
      if(bookHomeVisit) bookHomeVisit.onclick = ()=> bookHomeVisitOrTele("home");

      const bookTele = document.getElementById("bookTele");
      if(bookTele) bookTele.onclick = ()=> bookHomeVisitOrTele("tele");
    }

    function renderAppointments(){
      const appts = getAllAppointments();

      // basic grouping
      const mother = appts.filter(a=>a.for==="mother");
      const baby = appts.filter(a=>a.for==="baby");

      contentEl.innerHTML = `
        <div class="card">
          <div style="font-size:12px;color:rgba(232,240,255,.60);margin-bottom:6px">Appointments</div>
          <div style="font-size:18px;font-weight:900">Mother & Baby schedule</div>
          <div class="muted" style="font-size:12px;line-height:1.45;margin-top:6px">
            Includes pregnancy/birth appointments and post-birth bookings (vaccination + visitation).
          </div>
          <div class="cta">
            <button class="btn ghost" id="goPost">Go to Post-birth</button>
            <button class="btn primary" id="bookVxFromAppts">Book next vaccination</button>
          </div>
        </div>

        <div class="section">
          <div class="sectionhead"><h3>Baby</h3><button class="linkbtn" id="babyHint">Details</button></div>
          ${baby.length ? `
            <div class="list">
              ${baby.map(a=>`
                <div class="item" data-apptid="${a.id}">
                  <div class="thumb">${svgBadge(a.type==="Vaccination" ? "cal" : "heart")}</div>
                  <div class="meta">
                    <div class="t">${escapeHtml(a.title)}</div>
                    <div class="d">${fmtDate(a.date)} • ${escapeHtml(a.location)}</div>
                    <div class="tags">
                      <span class="tag">${escapeHtml(a.type)}</span>
                      <span class="tag good">${escapeHtml(a.status)}</span>
                    </div>
                  </div>
                  <div class="chev">›</div>
                </div>
              `).join("")}
            </div>
          ` : `<div class="card"><div class="muted" style="font-size:12px">No baby appointments yet. Book a vaccination or visitation.</div></div>`}
        </div>

        <div class="section">
          <div class="sectionhead"><h3>Mother</h3><button class="linkbtn" id="motherHint">Details</button></div>
          ${mother.length ? `
            <div class="list">
              ${mother.map(a=>`
                <div class="item" data-apptid="${a.id}">
                  <div class="thumb">${svgBadge("cal")}</div>
                  <div class="meta">
                    <div class="t">${escapeHtml(a.title)}</div>
                    <div class="d">${fmtDate(a.date)} • ${escapeHtml(a.location)}</div>
                    <div class="tags">
                      <span class="tag">${escapeHtml(a.type)}</span>
                      <span class="tag">${escapeHtml(a.status)}</span>
                    </div>
                  </div>
                  <div class="chev">›</div>
                </div>
              `).join("")}
            </div>
          ` : `<div class="card"><div class="muted" style="font-size:12px">No mother appointments (prototype).</div></div>`}
        </div>
      `;

      document.getElementById("goPost").onclick = ()=> setStage("post");
      document.getElementById("bookVxFromAppts").onclick = ()=> bookNextVaccination();

      document.getElementById("babyHint").onclick = ()=> showToast("Baby appointments: vaccination + postnatal services.");
      document.getElementById("motherHint").onclick = ()=> showToast("Mother appointments: prenatal + delivery.");

      contentEl.querySelectorAll("[data-apptid]").forEach(el=>{
        el.onclick = ()=>{
          const appt = getAllAppointments().find(a=>a.id===el.dataset.apptid);
          if(!appt) return;
          openModal({
            title: appt.title,
            desc: `${fmtDate(appt.date)}\n${appt.location}\n\nFor: ${appt.for}\nType: ${appt.type}\nStatus: ${appt.status}`,
            options:[
              {k:"Reminders", v: "Vaccination has 2-day reminder"},
              {k:"Demo date", v: state.simNow ? fmtDate(now()) + " (simulated)" : fmtDate(now())}
            ],
            primaryLabel:"OK",
            primaryAction: ()=>{}
          });
        };
      });
    }

    function renderResources(){
      // lightweight placeholder (you can expand later per stage)
      const stageName = STAGES[state.stage].name;
      contentEl.innerHTML = `
        <div class="card">
          <div style="font-size:12px;color:rgba(232,240,255,.60);margin-bottom:6px">Resources • ${escapeHtml(stageName)}</div>
          <div style="font-size:18px;font-weight:900">Educational content (prototype)</div>
          <div class="muted" style="font-size:12px;line-height:1.45;margin-top:6px">
            Next iteration: tailor content by pregnancy week, newborn age, screening results, vaccination due dates, and care pathway.
          </div>
          <div class="cta">
            <button class="btn primary" id="goDash">Back to dashboard</button>
            <button class="btn ghost" id="goPostTab">Open Newborn Screening</button>
          </div>
        </div>
      `;
      document.getElementById("goDash").onclick = ()=> setView("dashboard");
      document.getElementById("goPostTab").onclick = ()=>{
        setStage("post");
        state.post.tab="nbs";
        render();
      };
    }

    function renderProfile(){
      contentEl.innerHTML = `
        <div class="card">
          <div style="font-size:12px;color:rgba(232,240,255,.60);margin-bottom:6px">Me</div>
          <div style="font-size:18px;font-weight:900">Profile (auto-created)</div>
          <div class="muted" style="font-size:12px;line-height:1.45;margin-top:6px">
            Auto-created from the hospital confirmation. Next iteration: language, consent, care pathway, and notification preferences.
          </div>

          <div class="kpiwrap">
            <div class="kpi">
              <div class="label">Current stage</div>
              <div class="value">${escapeHtml(STAGES[state.stage].name)}</div>
              <div class="hint">Controls dashboard experience</div>
            </div>
            <div class="kpi">
              <div class="label">Demo date</div>
              <div class="value">${fmtShort(now())}${state.simNow ? " *" : ""}</div>
              <div class="hint">${state.simNow ? "Simulated for notifications" : "Real time"}</div>
            </div>
          </div>

          <div class="cta">
            <button class="btn primary" id="toggleDemo">Reset demo date</button>
            <button class="btn ghost" id="goAppointments">Appointments</button>
          </div>
        </div>
      `;
      document.getElementById("toggleDemo").onclick = ()=>{
        state.simNow = null;
        showToast("Demo date reset.");
        render();
      };
      document.getElementById("goAppointments").onclick = ()=> setView("appointments");
    }

    function render(){
      stageSubtitle.textContent = STAGES[state.stage].subtitle;

      if(state.view === "dashboard"){
        if(state.stage === "preg") renderDashboardPregnancy();
        else if(state.stage === "birth") renderDashboardBirth();
        else if(state.stage === "post") renderPostDashboard();
        else renderDashboardPregnancy(); // fallback
      }

      if(state.view === "appointments") renderAppointments();
      if(state.view === "resources") renderResources();
      if(state.view === "profile") renderProfile();
    }

    // ---------------------------
    // Icons
    // ---------------------------
    function svgBadge(kind){
      const map = {
        cal: `<svg class="svg" viewBox="0 0 24 24" fill="none">
          <path d="M7 3v3M17 3v3M4 8h16" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          <path d="M6 6h12a2 2 0 0 1 2 2v12a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2Z" stroke="currentColor" stroke-width="2"/>
        </svg>`,
        book: `<svg class="svg" viewBox="0 0 24 24" fill="none">
          <path d="M6 4h12v16H6V4Z" stroke="currentColor" stroke-width="2"/>
          <path d="M9 8h6M9 12h6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        </svg>`,
        heart: `<svg class="svg" viewBox="0 0 24 24" fill="none">
          <path d="M12 21s-7-4.35-9.5-9A5.8 5.8 0 0 1 12 5.8 5.8 5.8 0 0 1 21.5 12c-2.5 4.65-9.5 9-9.5 9Z" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/>
        </svg>`
      };
      return map[kind] || map.book;
    }

    // ---------------------------
    // Global event wiring
    // ---------------------------
    stageBar.addEventListener("click", (e)=>{
      const el = e.target.closest(".pill");
      if(!el || !el.dataset.stage) return;
      setStage(el.dataset.stage);
    });

    stageBar.addEventListener("keydown", (e)=>{
      const el = e.target.closest(".pill");
      if(!el || !el.dataset.stage) return;
      if(e.key === "Enter" || e.key === " "){
        e.preventDefault();
        setStage(el.dataset.stage);
      }
    });

    navBtns.forEach(btn=>{
      btn.addEventListener("click", ()=> setView(btn.dataset.view));
    });

    modalClose.onclick = closeModal;
    modalBack.addEventListener("click", (e)=>{
      if(e.target === modalBack) closeModal();
    });

    document.getElementById("infoBtn").onclick = ()=>{
      const baby = state.journey.baby;
      const active = getActiveNotifications();

      openModal({
        title:"Having a Baby • Summary",
        desc:
          `Stage: ${STAGES[state.stage].name}\n\n` +
          `Hospital event: ${state.journey.hospitalEvent.event}\n` +
          `Test confirmed: ${fmtDate(state.journey.testDate)}\n` +
          `Due date (est.): ${fmtDate(state.journey.dueDate)}\n\n` +
          (state.deliveryCompleted
            ? `Baby born: ${fmtDate(baby.birthDate)}\nNBS results: ${baby.screenings.length}\nVaccines scheduled: ${baby.vaccines.length}\n\n`
            : "Birth not completed yet.\n\n"
          ) +
          (active.length ? `Active notification:\n• ${active[0].message}` : "No active notifications right now."),
        options:[
          {k:"Action", v:"Go to Post-birth", onClick: ()=>{ setStage("post"); }},
          {k:"Action", v:"Complete birth (demo)", onClick: ()=>{ completeBirthAndTransferToPostnatal(); }}
        ],
        primaryLabel:"OK",
        primaryAction: ()=>{}
      });
    };

    document.getElementById("backBtn").onclick = ()=> showToast("Back (prototype).");

    // ---------------------------
    // Boot
    // ---------------------------
    initPregnancyFlow();
    render();
  </script>
</body>
</html>
